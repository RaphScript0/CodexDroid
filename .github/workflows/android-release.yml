name: Android Release (Signed APK)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build Signed APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Ensure Android project exists
        run: |
          cd flutter-app
          if [ ! -d android ]; then
            flutter create . --platforms=android
          fi

      - name: Inject signing config
        run: |
          cd flutter-app/android
          python - <<'PY'
          from pathlib import Path
          import re

          gradle = Path('app/build.gradle')
          text = gradle.read_text()

          if 'def keystoreProperties' not in text:
            header = """def keystoreProperties = new Properties()\n"""
            header += """def keystorePropertiesFile = rootProject.file('key.properties')\n"""
            header += """if (keystorePropertiesFile.exists()) {\n"""
            header += """    keystoreProperties.load(new FileInputStream(keystorePropertiesFile))\n"""
            header += """}\n\n"""
            text = header + text

          if 'signingConfigs' not in text:
            insert = """
    signingConfigs {
        release {
            keyAlias keystoreProperties['keyAlias']
            keyPassword keystoreProperties['keyPassword']
            storeFile keystoreProperties['storeFile'] ? file(keystoreProperties['storeFile']) : null
            storePassword keystoreProperties['storePassword']
        }
    }
"""
            text = re.sub(r'(defaultConfig\s*\{[^\}]*\}\s*)', r"\1\n" + insert, text, count=1, flags=re.S)

          if 'signingConfig signingConfigs.release' not in text:
            if 'signingConfig signingConfigs.debug' in text:
              text = text.replace('signingConfig signingConfigs.debug', 'signingConfig signingConfigs.release')
            else:
              text = re.sub(r'(release\s*\{)', r"\1\n            signingConfig signingConfigs.release", text, count=1)

          gradle.write_text(text)
          PY

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          mkdir -p flutter-app/android/app
          echo $ANDROID_KEYSTORE_BASE64 | base64 --decode > flutter-app/android/app/keystore.jks

      - name: Generate key.properties
        run: |
          cat <<EOF > flutter-app/android/key.properties
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/keystore.jks
          EOF

      - name: Install Dependencies
        run: |
          cd flutter-app
          flutter pub get

      - name: Build Signed APK
        run: |
          cd flutter-app
          flutter build apk --release

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-signed
          path: flutter-app/build/app/outputs/flutter-apk/app-release.apk
          retention-days: 30
